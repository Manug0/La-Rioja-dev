pipeline {
    agent any
    environment {
        SFDX_AUTH_URL = credentials('SFDX_AUTH_URL_PRE')
        SFDX_ALIAS = 'pre'
        PACKAGE_DIR = 'force-app'
        SF_DISABLE_TELEMETRY = "true"
        SF_CMD = 'C:\\Users\\Manu\\AppData\\Local\\sf\\client\\2.92.7-df40848\\bin\\sf.cmd'
    }
    
    // Solo ejecutar en main branch despuÃ©s de merge
    when {
        branch 'main'
    }
    
    stages {
        stage('Verificar Prerequisites') {
            steps {
                script {
                    echo "ğŸ” Verificando prerequisites para deploy..."
                    
                    // Verificar que este commit viene de un merge de PR
                    def commitMessage = bat(script: "git log -1 --pretty=format:%%s", returnStdout: true).trim()
                    echo "ğŸ“‹ Commit message: ${commitMessage}"
                    
                    if (commitMessage.contains("Merge pull request")) {
                        echo "âœ… Deploy autorizado - Commit proviene de merge de PR"
                        env.DEPLOY_AUTHORIZED = "true"
                    } else {
                        echo "âŒ Deploy NO autorizado - Commit no proviene de merge de PR"
                        env.DEPLOY_AUTHORIZED = "false"
                        error("Deploy cancelado: Solo se permite deploy desde merge de PR validado")
                    }
                }
            }
        }
        
        stage('ConfirmaciÃ³n Manual') {
            steps {
                script {
                    echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                 ğŸš€ CONFIRMACIÃ“N DE DEPLOY                    â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Entorno: PRODUCCIÃ“N                                         â•‘
â•‘ Branch: ${env.BRANCH_NAME}                                  â•‘
â•‘ Commit: ${env.GIT_COMMIT?.take(8)}                          â•‘
â•‘                                                              â•‘
â•‘ âš ï¸  ATENCIÃ“N: Vas a desplegar a PRODUCCIÃ“N                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
                    
                    // Pausa para confirmaciÃ³n manual
                    def userInput
                    try {
                        timeout(time: 10, unit: 'MINUTES') {
                            userInput = input(
                                id: 'DeployConfirmation',
                                message: 'ğŸš€ Confirmar deploy a PRODUCCIÃ“N',
                                parameters: [
                                    choice(
                                        name: 'DEPLOY_ACTION',
                                        choices: ['CANCELAR', 'DEPLOY_NORMAL', 'DEPLOY_CON_TESTS'],
                                        description: 'Selecciona el tipo de deploy'
                                    )
                                ]
                            )
                        }
                    } catch (err) {
                        echo "âŒ Timeout o cancelaciÃ³n manual del deploy"
                        error("Deploy cancelado por timeout o intervenciÃ³n manual")
                    }
                    
                    env.DEPLOY_TYPE = userInput
                    echo "âœ… Tipo de deploy seleccionado: ${env.DEPLOY_TYPE}"
                    
                    if (env.DEPLOY_TYPE == 'CANCELAR') {
                        error("Deploy cancelado manualmente")
                    }
                }
            }
        }
        
        stage('Checkout') { 
            steps { 
                checkout scm 
                echo "âœ… CÃ³digo descargado desde main branch"
            }
        }
        
        stage('Verificar SFDX') { 
            steps { 
                script {
                    echo "ğŸ”§ Verificando SFDX CLI..."
                    bat "${SF_CMD} --version"
                    echo "âœ… SFDX CLI verificado"
                }
            }
        }
        
        stage('Authenticate') {
            steps {
                script {
                    echo "ğŸ” Autenticando con org de producciÃ³n..."
                    bat 'echo %SFDX_AUTH_URL% > auth_url.txt'
                    bat "${SF_CMD} org login sfdx-url --sfdx-url-file auth_url.txt --alias %SFDX_ALIAS%"
                    echo "âœ… AutenticaciÃ³n exitosa"
                }
            }
        }
        
        stage('Generar Package Deploy') {
            steps {
                script {
                    echo "ğŸ“¦ Generando package para deploy..."
                    
                    // Crear directorio package si no existe
                    bat "if not exist package mkdir package"
                    
                    try {
                        // Intentar obtener los cambios del Ãºltimo merge
                        def lastMergeCommit = bat(script: "git log --merges -1 --pretty=format:%%H", returnStdout: true).trim()
                        def parentCommits = bat(script: "git log --pretty=format:%%P -1 ${lastMergeCommit}", returnStdout: true).trim().split(' ')
                        
                        if (parentCommits.length >= 2) {
                            def fromCommit = parentCommits[0]  // Commit de main antes del merge
                            def toCommit = parentCommits[1]    // Ãšltimo commit de la rama mergeada
                            
                            echo "ğŸ”„ Generando delta desde ${fromCommit} hasta ${toCommit}"
                            
                            // Verificar plugin sfdx-git-delta
                            def pluginCheck = bat(script: "${SF_CMD} plugins | findstr sfdx-git-delta", returnStatus: true)
                            
                            if (pluginCheck == 0) {
                                bat "\"${SF_CMD}\" sgd source delta --from \"${fromCommit}\" --to \"${toCommit}\" --output ."
                                echo "âœ… Package.xml generado con delta"
                            } else {
                                echo "âš ï¸ Plugin sfdx-git-delta no encontrado, usando package completo"
                                createProductionPackage()
                            }
                        } else {
                            echo "âš ï¸ No se pudo determinar el delta, usando package completo"
                            createProductionPackage()
                        }
                        
                    } catch (Exception e) {
                        echo "âš ï¸ Error generando delta: ${e.getMessage()}"
                        echo "ğŸ”„ Usando package completo como fallback"
                        createProductionPackage()
                    }
                    
                    // Verificar que el package.xml existe
                    if (fileExists('package\\package.xml')) {
                        echo "ğŸ“„ Contenido del package.xml:"
                        bat "type package\\package.xml"
                        echo "âœ… Package.xml listo para deploy"
                    } else {
                        error("âŒ Error: package.xml no encontrado")
                    }
                }
            }
        }
        
        stage('Deploy a ProducciÃ³n') {
            steps {
                script {
                    echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                ğŸš€ INICIANDO DEPLOY A PRODUCCIÃ“N              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
                    
                    try {
                        if (env.DEPLOY_TYPE == 'DEPLOY_CON_TESTS') {
                            echo "ğŸ§ª Deploy con tests completos..."
                            bat "${SF_CMD} project deploy start --manifest package\\package.xml --target-org %SFDX_ALIAS% --wait 30 --test-level RunLocalTests"
                        } else {
                            echo "ğŸš€ Deploy normal (sin tests adicionales)..."
                            bat "${SF_CMD} project deploy start --manifest package\\package.xml --target-org %SFDX_ALIAS% --wait 30"
                        }
                        
                        echo "âœ… Deploy completado exitosamente"
                        
                    } catch (Exception e) {
                        echo "âŒ Error en deploy: ${e.getMessage()}"
                        throw e
                    }
                }
            }
        }
        
        stage('Verificar Deploy') {
            steps {
                script {
                    echo "ğŸ” Verificando estado del deploy..."
                    
                    try {
                        // Verificar el Ãºltimo deploy
                        bat "${SF_CMD} project deploy report --target-org %SFDX_ALIAS%"
                        echo "âœ… VerificaciÃ³n completada"
                        
                    } catch (Exception e) {
                        echo "âš ï¸ Error verificando deploy: ${e.getMessage()}"
                        // No fallar el pipeline por esto
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                // Limpiar archivos temporales
                bat "if exist auth_url.txt del auth_url.txt"
                echo "ğŸ§¹ Archivos temporales limpiados"
            }
        }
        success { 
            script {
                echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘               ğŸ‰ DEPLOY A PRODUCCIÃ“N EXITOSO                 â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Branch: ${env.BRANCH_NAME}                                   â•‘
â•‘ Commit: ${env.GIT_COMMIT?.take(8)}                           â•‘
â•‘ Fecha: ${new Date()}                                         â•‘
â•‘ Tipo de Deploy: ${env.DEPLOY_TYPE}                           â•‘
â•‘                                                              â•‘
â•‘ âœ… ESTADO: CÃ³digo desplegado exitosamente en producciÃ³n     â•‘
â•‘                                                              â•‘
â•‘ PrÃ³ximos pasos:                                             â•‘
â•‘ â€¢ Verificar funcionalidad en producciÃ³n                    â•‘
â•‘ â€¢ Monitorear logs de errores                               â•‘
â•‘ â€¢ Comunicar a usuarios finales si es necesario             â•‘
â•‘                                                              â•‘
â•‘ ğŸ”— Jenkins: ${BUILD_URL}console                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
                
                // Marcar el build como exitoso con descripciÃ³n
                currentBuild.description = "ğŸ‰ Deploy exitoso a producciÃ³n"
                currentBuild.result = 'SUCCESS'
            }
        }
        failure { 
            script {
                echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                ğŸ’¥ DEPLOY A PRODUCCIÃ“N FALLÃ“                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Branch: ${env.BRANCH_NAME}                                   â•‘
â•‘ Commit: ${env.GIT_COMMIT?.take(8)}                           â•‘
â•‘ Fecha: ${new Date()}                                         â•‘
â•‘ Tipo de Deploy: ${env.DEPLOY_TYPE ?: 'No especificado'}     â•‘
â•‘                                                              â•‘
â•‘ âŒ ESTADO: Deploy fallÃ³ - ProducciÃ³n NO afectada            â•‘
â•‘                                                              â•‘
â•‘ Acciones requeridas:                                        â•‘
â•‘ 1. Revisar logs de Jenkins para identificar el error       â•‘
â•‘ 2. Corregir problemas en cÃ³digo                            â•‘
â•‘ 3. Crear nuevo PR con las correcciones                     â•‘
â•‘ 4. Re-ejecutar validaciones                                â•‘
â•‘ 5. Intentar deploy nuevamente                              â•‘
â•‘                                                              â•‘
â•‘ ğŸ”— Jenkins: ${BUILD_URL}console                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
                
                // Marcar el build como fallido con descripciÃ³n
                currentBuild.description = "ğŸ’¥ Deploy fallÃ³ - Revisar logs"
                currentBuild.result = 'FAILURE'
            }
        }
        aborted {
            script {
                echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              â¹ï¸ DEPLOY A PRODUCCIÃ“N CANCELADO                â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Motivo: Cancelado manualmente o por timeout                 â•‘
â•‘ Fecha: ${new Date()}                                         â•‘
â•‘                                                              â•‘
â•‘ â„¹ï¸ ESTADO: No se realizaron cambios en producciÃ³n          â•‘
â•‘                                                              â•‘
â•‘ Para reintentar:                                            â•‘
â•‘ â€¢ Ejecutar manualmente el pipeline de deploy               â•‘
â•‘ â€¢ O hacer un nuevo push a main (si es necesario)           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
                
                currentBuild.description = "â¹ï¸ Deploy cancelado manualmente"
            }
        }
    }
}

// FunciÃ³n para crear package.xml de producciÃ³n
def createProductionPackage() {
    def packageXml = '''<?xml version="1.0" encoding="UTF-8"?>
<Package xmlns="http://soap.sforce.com/2006/04/metadata">
    <types>
        <members>HSU_SistemasUpdater</members>
        <members>HSU_UTSUpdater</members>
        <members>HSU_SistemasUpdater_TEST</members>
        <members>HSU_UTSUpdater_TEST</members>
        <n>ApexClass</n>
    </types>
    <types>
        <members>HSU_GlobalLists__c</members>
        <n>CustomObject</n>
    </types>
    <version>59.0</version>
</Package>'''
    
    writeFile file: 'package/package.xml', text: packageXml
    echo "âœ… Package.xml de producciÃ³n creado"
}